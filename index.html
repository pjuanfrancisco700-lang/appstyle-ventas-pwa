<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Registro de Clientes</title>
  <style>
    :root {
      --bg: #F4F5F7;
      --card: #FFFFFF;
      --accent: #0F5C9A; /* estilo SAP */
      --accent-soft: #E3ECF5;
      --border: #D0D4DC;
      --text-main: #111827;
      --text-soft: #6B7280;
      --danger: #B91C1C;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 12px;
      background: var(--bg);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      max-width: 480px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .top-bar {
      background: var(--card);
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
      border: 1px solid var(--border);
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .icon-button {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--accent-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      transition: background 0.15s, transform 0.05s;
    }

    .icon-button:active {
      transform: scale(0.97);
      background: #d4e0f0;
    }

    .top-title {
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--accent);
    }

    .top-right {
      text-align: right;
      max-width: 50%;
    }

    .field-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    .input-sm {
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      font-size: 13px;
      outline: none;
      width: 92px;
    }

    .input-sm:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .route-group {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.06);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .row.space-between {
      justify-content: space-between;
    }

    .select {
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      font-size: 13px;
      outline: none;
      flex: 1;
      background: #F9FAFB;
    }

    .select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .day-hint {
      font-size: 11px;
      color: var(--text-soft);
    }

    .search-input {
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 8px 10px;
      font-size: 13px;
      outline: none;
      flex: 1;
      background: #F9FAFB;
    }

    .search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .pill-button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      background: var(--accent);
      color: #FFF;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s, transform 0.05s;
    }

    .pill-button.secondary {
      background: #F3F4F6;
      color: var(--text-main);
    }

    .pill-button.full {
      width: 100%;
      justify-content: center;
    }

    .pill-button:active {
      transform: scale(0.98);
      background: #0B4A7A;
    }

    .pill-button.secondary:active {
      background: #E5E7EB;
    }

    .results-list {
      max-height: 150px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #F9FAFB;
    }

    .result-item {
      padding: 6px 8px;
      border-bottom: 1px solid #E5E7EB;
      font-size: 13px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-item:hover {
      background: #E5EDF7;
    }

    .result-name {
      font-weight: 600;
    }

    .result-meta {
      font-size: 11px;
      color: var(--text-soft);
    }

    .selected-badge {
      font-size: 11px;
      color: var(--text-soft);
    }

    .selected-name {
      font-size: 13px;
      font-weight: 600;
    }

    .status-text {
      font-size: 11px;
      color: var(--text-soft);
    }

    .status-text.error {
      color: var(--danger);
    }

    .restruct-card {
      margin-top: 2px;
    }

    .day-block {
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #F9FAFB;
      overflow: hidden;
    }

    .day-header {
      padding: 6px 8px;
      background: var(--accent-soft);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--accent);
    }

    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #E5E7EB;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: #EEF2F7;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #374151;
    }

    tr:nth-child(even) td {
      background: #F9FAFB;
    }

    tr:nth-child(odd) td {
      background: #FFFFFF;
    }

    .footer-space {
      height: 10px;
    }

    .restruct-button {
      margin-top: 2px;
    }

    /* Toggle switch */
    .toggle-switch {
      width: 32px;
      height: 16px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #F3F4F6;
      padding: 2px;
      display: flex;
      align-items: center;
      transition: background 0.15s;
    }

    .toggle-knob {
      width: 12px;
      height: 12px;
      border-radius: 999px;
      background: #4B5563;
      transition: transform 0.15s, background 0.15s;
    }

    .toggle-switch.on {
      background: var(--accent-soft);
    }

    .toggle-switch.on .toggle-knob {
      transform: translateX(14px);
      background: var(--accent);
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.38);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .modal {
      background: var(--card);
      border-radius: 16px;
      padding: 14px 14px 12px;
      width: 92%;
      max-width: 420px;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.28);
      border: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
    }

    .modal-grid {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .modal-input {
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 7px 8px;
      font-size: 13px;
      outline: none;
      width: 100%;
      background: #F9FAFB;
    }

    .modal-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 4px;
    }

    .chip-day {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .hidden-input {
      display: none;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- Encabezado / pesta√±a superior -->
    <header class="top-bar">
      <div class="top-left">
        <label class="icon-button" title="Cargar base de datos (.txt)">
          üìÅ
          <input id="fileInput" type="file" accept=".txt" class="hidden-input" />
        </label>
        <div class="route-group">
          <span class="field-label">Ruta</span>
          <input id="routeInput" type="text" class="input-sm" placeholder="17029" />
        </div>
      </div>
      <div class="top-right">
        <div class="top-title">Registro de clientes</div>
      </div>
    </header>

    <!-- Selector de d√≠a -->
    <section class="card">
      <div class="row space-between" style="align-items: flex-end;">
        <div style="flex: 1;">
          <div class="field-label">D√≠a</div>
          <select id="daySelect" class="select">
            <option value="Lunes">Lunes</option>
            <option value="Martes">Martes</option>
            <option value="Mi√©rcoles">Mi√©rcoles</option>
            <option value="Jueves">Jueves</option>
            <option value="Viernes">Viernes</option>
            <option value="S√°bado">S√°bado</option>
          </select>
        </div>
        <div class="day-hint" id="dayHint" style="display:none;"></div>
      </div>
    </section>

    <!-- B√∫squeda + nuevo cliente -->
    <section class="card">
      <div class="field-label" style="display:none;">Buscar cliente</div>
      <div class="row">
        <input id="searchInput" type="text" class="search-input" placeholder="Buscar por ruta o negocio" />
        <button id="newClientBtn" class="icon-button" title="Nuevo cliente">
          +
        </button>
      </div>
      <div id="searchStatus" class="status-text">Cargue una base de datos .txt para comenzar.</div>
      <div id="results" class="results-list" style="display:none;"></div>
      <div id="selectionInfo" class="row space-between" style="margin-top:4px;">
        <div>
          <div class="selected-badge" id="selectedBadge">Ning√∫n cliente seleccionado.</div>
          <div class="selected-name" id="selectedName"></div>
        </div>
        <button id="saveBtn" class="pill-button" style="min-width:96px;">
          GUARDAR
        </button>
      </div>
    </section>

    <!-- Reestructura -->
    <section class="card restruct-card">
      <div class="row space-between" style="align-items:center;">
        <div>
          <div class="field-label">Tabla reestructurada</div>
          <div class="status-text" id="restructStatus">Presione Reestructura para generar la vista organizada por d√≠a.</div>
        </div>
      </div>
      <div class="row" style="gap:6px; margin-top:4px;">
        <button id="toggleRestructBtn" class="icon-button" title="Ocultar/mostrar tabla">
          <span id="toggleVisual" class="toggle-switch on">
            <span class="toggle-knob"></span>
          </span>
        </button>
        <button id="clearBtn" class="icon-button" title="Limpiar asignaciones">üóëÔ∏è</button>
        <button id="excelBtn" class="pill-button secondary" style="padding:4px 10px;font-size:11px;">EXCEL</button>
        <button id="restructBtn" class="pill-button full restruct-button">Reestructura</button>
      </div>
      <div id="restructContainer"></div>
    </section>

    <div class="footer-space"></div>
  </div>

  <!-- Modal nuevo cliente -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-title">Nuevo cliente</div>
      <div class="status-text" id="modalDayInfo"></div>
      <div class="modal-grid">
        <div>
          <div class="field-label">Ruta</div>
          <input id="modalRuta" type="text" class="modal-input" />
        </div>
        <div>
          <div class="field-label">C√≥digo</div>
          <input id="modalCodigo" type="text" class="modal-input" />
        </div>
        <div>
          <div class="field-label">Nombre del negocio</div>
          <input id="modalNombre" type="text" class="modal-input" />
        </div>
        <div>
          <div class="field-label">Direcci√≥n</div>
          <input id="modalDireccion" type="text" class="modal-input" />
        </div>
      </div>
      <div class="modal-actions">
        <button id="cancelModalBtn" class="pill-button secondary">Cancelar</button>
        <button id="saveModalBtn" class="pill-button">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // --------- Estado principal ----------
    const state = {
      baseData: [], // clientes de la base original + nuevos clientes
      assignedByDay: { // clientes asignados por d√≠a
        'Lunes': [],
        'Martes': [],
        'Mi√©rcoles': [],
        'Jueves': [],
        'Viernes': [],
        'S√°bado': []
      },
      selectedClient: null
    };

    const daysOrder = ['Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];

    // --------- Elementos DOM ----------
    const fileInput = document.getElementById('fileInput');
    const routeInput = document.getElementById('routeInput');
    const daySelect = document.getElementById('daySelect');
    const dayHint = document.getElementById('dayHint');

    const searchInput = document.getElementById('searchInput');
    const searchStatus = document.getElementById('searchStatus');
    const resultsContainer = document.getElementById('results');
    const selectedBadge = document.getElementById('selectedBadge');
    const selectedName = document.getElementById('selectedName');
    const saveBtn = document.getElementById('saveBtn');

    const restructBtn = document.getElementById('restructBtn');
    const restructStatus = document.getElementById('restructStatus');
    const restructContainer = document.getElementById('restructContainer');
    const toggleRestructBtn = document.getElementById('toggleRestructBtn');
    const clearBtn = document.getElementById('clearBtn');
    const excelBtn = document.getElementById('excelBtn');
    const toggleVisual = document.getElementById('toggleVisual');

    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalRuta = document.getElementById('modalRuta');
    const modalCodigo = document.getElementById('modalCodigo');
    const modalNombre = document.getElementById('modalNombre');
    const modalDireccion = document.getElementById('modalDireccion');
    const modalDayInfo = document.getElementById('modalDayInfo');
    const newClientBtn = document.getElementById('newClientBtn');
    const cancelModalBtn = document.getElementById('cancelModalBtn');
    const saveModalBtn = document.getElementById('saveModalBtn');

    // --------- Persistencia localStorage ----------
    const STORAGE_KEYS = {
      baseData: 'rc_baseData',
      assignedByDay: 'rc_assignedByDay',
      route: 'rc_route'
    };

    function persistState() {
      try {
        localStorage.setItem(STORAGE_KEYS.baseData, JSON.stringify(state.baseData));
        localStorage.setItem(STORAGE_KEYS.assignedByDay, JSON.stringify(state.assignedByDay));
        localStorage.setItem(STORAGE_KEYS.route, routeInput.value.trim() || '');
      } catch (e) {
        console.warn('No se pudo guardar en localStorage', e);
      }
    }

    function loadPersistedState() {
      try {
        const baseRaw = localStorage.getItem(STORAGE_KEYS.baseData);
        const assignedRaw = localStorage.getItem(STORAGE_KEYS.assignedByDay);
        const routeRaw = localStorage.getItem(STORAGE_KEYS.route);

        if (routeRaw) {
          routeInput.value = routeRaw;
        }

        if (baseRaw) {
          const parsedBase = JSON.parse(baseRaw);
          if (Array.isArray(parsedBase)) {
            state.baseData = parsedBase;
            searchStatus.textContent = `Base cargada: ${parsedBase.length} clientes (guardada).`;
          }
        }

        if (assignedRaw) {
          const parsedAssigned = JSON.parse(assignedRaw) || {};
          daysOrder.forEach(d => {
            if (Array.isArray(parsedAssigned[d])) {
              state.assignedByDay[d] = parsedAssigned[d];
            }
          });
        }

        const hasAssigned = daysOrder.some(d => (state.assignedByDay[d] || []).length > 0);
        if (hasAssigned) {
          renderRestruct();
        }
      } catch (e) {
        console.warn('No se pudo leer localStorage', e);
      }
    }

    // --------- Utilidades ----------
    function getTodayLabel() {
      const d = new Date();
      const jsDay = d.getDay(); // 0=Domingo ... 6=S√°bado
      const map = {
        1: 'Lunes',
        2: 'Martes',
        3: 'Mi√©rcoles',
        4: 'Jueves',
        5: 'Viernes',
        6: 'S√°bado'
      };
      return map[jsDay] || 'Lunes';
    }

    function parseTxtContent(text) {
      const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
      const parsed = [];

      for (const line of lines) {
        let parts;
        if (line.includes('\t')) {
          parts = line.split('\t');
        } else if (line.includes(';')) {
          parts = line.split(';');
        } else if (line.includes('|')) {
          parts = line.split('|');
        } else if (line.includes(',')) {
          parts = line.split(',');
        } else {
          // Fallback: separar por espacios (3 primeros campos fijos, resto direcci√≥n)
          const tokens = line.split(/\s+/);
          if (tokens.length >= 4) {
            const ruta = tokens[0];
            const codigo = tokens[1];
            const nombre = tokens[2];
            const direccion = tokens.slice(3).join(' ');
            parsed.push({ ruta, codigo, nombre, direccion });
            continue;
          }
          continue;
        }

        if (parts.length < 4) continue;

        const [ruta, codigo, nombre, direccion] = parts.map(p => p.trim());
        parsed.push({
          ruta: ruta || '',
          codigo: codigo || '',
          nombre: nombre || '',
          direccion: direccion || ''
        });
      }

      return parsed;
    }

    function renderSearchResults(list) {
      resultsContainer.innerHTML = '';
      if (!list || list.length === 0) {
        resultsContainer.style.display = 'none';
        return;
      }

      list.forEach(client => {
        const item = document.createElement('div');
        item.className = 'result-item';
        item.innerHTML = `
          <div class="result-name">${client.nombre || 'Sin nombre'}</div>
          <div class="result-meta">Ruta: ${client.ruta || '-'} ¬∑ C√≥digo: ${client.codigo || '-'}</div>
          <div class="result-meta">${client.direccion || ''}</div>
        `;
        item.addEventListener('click', () => {
          state.selectedClient = client;
          selectedBadge.textContent = 'Cliente seleccionado:';
          selectedName.textContent = client.nombre || 'Sin nombre';
        });
        resultsContainer.appendChild(item);
      });

      resultsContainer.style.display = 'block';
    }

    function searchClients(query) {
      const q = query.trim().toLowerCase();
      if (!q) {
        renderSearchResults([]);
        if (state.baseData.length === 0) {
          searchStatus.textContent = 'Cargue una base de datos .txt para comenzar.';
        } else {
          searchStatus.textContent = `Base cargada. Clientes disponibles: ${state.baseData.length}.`;
        }
        return;
      }

      const numeric = /^\d+$/.test(q);
      const matches = state.baseData.filter(c => {
        if (numeric) {
          return (c.ruta || '').toLowerCase().includes(q) || (c.codigo || '').toLowerCase().includes(q);
        }
        return (c.nombre || '').toLowerCase().includes(q);
      });

      if (matches.length === 0) {
        searchStatus.textContent = 'Sin coincidencias. Puede crear un cliente nuevo con el bot√≥n +';
      } else {
        searchStatus.textContent = `Coincidencias encontradas: ${matches.length}`;
      }

      renderSearchResults(matches);
    }

    function ensureUniqueAssignment(day, client) {
      const list = state.assignedByDay[day];
      const key = (client.ruta || '') + '|' + (client.codigo || '') + '|' + (client.nombre || '');
      const exists = list.some(c => (
        (c.ruta || '') + '|' + (c.codigo || '') + '|' + (c.nombre || '')
      ) === key);
      if (!exists) {
        list.push({ ...client });
      }
    }

    function renderRestruct() {
      restructContainer.innerHTML = '';

      let hasData = false;
      daysOrder.forEach((dayLabel, idx) => {
        const list = state.assignedByDay[dayLabel];
        if (!list || list.length === 0) return;
        hasData = true;

        const block = document.createElement('div');
        block.className = 'day-block';

        const header = document.createElement('div');
        header.className = 'day-header';
        header.textContent = `D√çA ${idx + 1} ‚Äì ${dayLabel.toUpperCase()}`;
        block.appendChild(header);

        const tableWrapper = document.createElement('div');
        tableWrapper.className = 'table-wrapper';

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th>#</th>
            <th>Ruta</th>
            <th>C√≥digo</th>
            <th>Negocio</th>
            <th>Direcci√≥n</th>
          </tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        list.forEach((client, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${client.ruta || ''}</td>
            <td>${client.codigo || ''}</td>
            <td>${client.nombre || ''}</td>
            <td>${client.direccion || ''}</td>
          `;
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        tableWrapper.appendChild(table);
        block.appendChild(tableWrapper);
        restructContainer.appendChild(block);
      });

      if (!hasData) {
        restructStatus.textContent = 'Sin clientes asignados todav√≠a. Guarde clientes para ver la reestructura.';
      } else {
        restructStatus.textContent = 'Vista reestructurada generada por d√≠a. Use Reestructura cuando actualice la asignaci√≥n.';
      }
    }

    function openModal() {
      modalRuta.value = routeInput.value.trim();
      modalCodigo.value = '';
      modalNombre.value = '';
      modalDireccion.value = '';
      const day = daySelect.value;
      modalDayInfo.innerHTML = `Se asignar√° al d√≠a <span class="chip-day">${day}</span>`;
      modalBackdrop.style.display = 'flex';
    }

    function closeModal() {
      modalBackdrop.style.display = 'none';
    }

    // --------- Eventos ----------
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const text = String(evt.target.result || '');
          const parsed = parseTxtContent(text);
          state.baseData = parsed;
          searchStatus.textContent = `Base cargada: ${parsed.length} clientes.`;
          searchClients(searchInput.value || '');
          persistState();
        } catch (err) {
          console.error(err);
          searchStatus.textContent = 'Error al leer el archivo. Verifique el formato.';
          searchStatus.classList.add('error');
        }
      };
      reader.readAsText(file, 'utf-8');
    });

    routeInput.addEventListener('input', () => {
      persistState();
    });

    searchInput.addEventListener('input', (e) => {
      searchClients(e.target.value || '');
    });

    saveBtn.addEventListener('click', () => {
      if (!state.selectedClient) {
        searchStatus.textContent = 'Seleccione un cliente de la lista o cree uno nuevo.';
        searchStatus.classList.add('error');
        return;
      }
      searchStatus.classList.remove('error');

      const day = daySelect.value;
      const currentRoute = routeInput.value.trim();
      const baseClient = state.selectedClient;
      const clientForDay = { ...baseClient };
      if (currentRoute) {
        clientForDay.ruta = currentRoute; // forzar ruta con la que est√°s trabajando
      }

      ensureUniqueAssignment(day, clientForDay);
      persistState();
      restructStatus.textContent = `Cliente asignado a ${day}. Presione Reestructura para actualizar la tabla.`;
    });

    toggleRestructBtn.addEventListener('click', () => {
      const isHidden = restructContainer.style.display === 'none';
      if (isHidden) {
        restructContainer.style.display = 'block';
        toggleVisual.classList.add('on');
      } else {
        restructContainer.style.display = 'none';
        toggleVisual.classList.remove('on');
      }
    });

    clearBtn.addEventListener('click', () => {
      const ok = confirm('¬øEst√° seguro de borrar todas las asignaciones y limpiar la tabla?');
      if (!ok) return;

      Object.keys(state.assignedByDay).forEach(day => {
        state.assignedByDay[day] = [];
      });
      restructContainer.innerHTML = '';
      restructStatus.textContent = 'Datos limpiados. Puede comenzar de nuevo.';
      persistState();
    });

    restructBtn.addEventListener('click', () => {
      renderRestruct();
    });

    excelBtn.addEventListener('click', () => {
      const hasData = daysOrder.some(d => (state.assignedByDay[d] || []).length > 0);
      if (!hasData) {
        alert('No hay datos reestructurados para exportar. Asigne clientes y use Reestructura primero.');
        return;
      }

      const headers = ['D√çA','ORDEN','RUTA','C√ìDIGO','NOMBRE DEL NEGOCIO','DIRECCI√ìN'];
      const rows = [];
      rows.push(headers);

      daysOrder.forEach((dayLabel, idx) => {
        const list = state.assignedByDay[dayLabel];
        if (!list || list.length === 0) return;
        // Fila t√≠tulo de d√≠a
        rows.push([`D√çA ${idx + 1} ‚Äì ${dayLabel.toUpperCase()}`,'','','','','']);
        list.forEach((client, index) => {
          const dia = dayLabel;
          const orden = index + 1;
          const ruta = client.ruta || '';
          const codigo = client.codigo || '';
          const nombre = client.nombre || '';
          const direccion = client.direccion || '';
          rows.push([dia, String(orden), ruta, codigo, nombre, direccion]);
        });
      });

      // Construir CSV (usamos ; como separador)
      const csvContent = rows
        .map(cols => cols.map(v => {
          const s = (v ?? '').toString().replace(/"/g, '""');
          return `"${s}"`;
        }).join(';'))
        .join('\r\n');

      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'Base_reestructurada.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    });

    newClientBtn.addEventListener('click', () => {
      if (state.baseData.length === 0) {
        searchStatus.textContent = 'Creando cliente nuevo sin base cargada.';
      }
      openModal();
    });

    cancelModalBtn.addEventListener('click', () => {
      closeModal();
    });

    saveModalBtn.addEventListener('click', () => {
      const ruta = modalRuta.value.trim();
      const codigo = modalCodigo.value.trim();
      const nombre = modalNombre.value.trim();
      const direccion = modalDireccion.value.trim();

      if (!ruta || !codigo || !nombre || !direccion) {
        alert('Complete todos los campos del nuevo cliente.');
        return;
      }

      const newClient = { ruta, codigo, nombre, direccion };

      // Agregar a base interna para futuras b√∫squedas
      state.baseData.push(newClient);

      // Asignar al d√≠a seleccionado
      const day = daySelect.value;
      ensureUniqueAssignment(day, newClient);
      persistState();

      closeModal();

      // Actualizar mensajes y selecci√≥n
      state.selectedClient = newClient;
      selectedBadge.textContent = 'Cliente creado y asignado:';
      selectedName.textContent = newClient.nombre;
      searchStatus.textContent = `Cliente nuevo agregado a la base y asignado a ${day}.`;

      // Si hay texto de b√∫squeda, refrescar
      if (searchInput.value.trim()) {
        searchClients(searchInput.value || '');
      }
    });

    // Cerrar modal al tocar fuera
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) {
        closeModal();
      }
    });

    // --------- Inicializaci√≥n ----------
    function initDaySelector() {
      const todayLabel = getTodayLabel();
      daySelect.value = todayLabel;
      dayHint.textContent = `D√≠a detectado: ${todayLabel}. Puede cambiarlo para asignar a otro d√≠a.`;
      dayHint.style.display = 'none'; // texto oculto como pediste
    }

    document.addEventListener('DOMContentLoaded', () => {
      initDaySelector();
      loadPersistedState();
    });
  </script>
</body>
</html>
