<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Registro de Clientes ‚Äî Ruta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <style>
    :root {
      --bg: #F2F2F7;
      --card: #FFFFFF;
      --border: #D0D5DD;
      --accent: #0F62A9;   /* Azul SAP */
      --accent-soft: #E3F2FF;
      --text-main: #111827;
      --text-muted: #6B7280;
      --danger: #B42318;
      --radius-lg: 16px;
      --radius-md: 10px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text-main);
      display: flex;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      max-width: 430px; /* pensado para smartphone */
      min-height: 100vh;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 10px 12px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
      border: 1px solid var(--border);
      gap: 10px;
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .icon-button {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      border: 1px solid var(--border);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #F9FAFB;
      cursor: pointer;
      font-size: 18px;
    }

    .icon-button:hover {
      background: #EEF2FF;
    }

    .route-box {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .route-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--text-muted);
    }

    .route-input {
      border: none;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      padding: 2px 0;
      width: 90px;
      outline: none;
      background: transparent;
    }

    .title {
      font-size: 13px;
      text-align: right;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
    }

    .main-card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 10px 10px 12px;
      border: 1px solid var(--border);
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.03);
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .row.wrap {
      flex-wrap: wrap;
      align-items: flex-start;
    }

    .field-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }

    select, input[type="text"] {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 7px 9px;
      font-size: 13px;
      outline: none;
      background: #F9FAFB;
    }

    select:focus, input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(15, 98, 169, 0.25);
      background: #FFFFFF;
    }

    .day-select-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1;
    }

    .day-info {
      font-size: 11px;
      color: var(--text-muted);
    }

    .search-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 2;
    }

    .big-box {
      margin-top: 4px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: #F9FAFB;
      padding: 6px;
      min-height: 170px;
      max-height: 260px;
      overflow-y: auto;
      font-size: 13px;
    }

    .client-item {
      padding: 6px 8px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 2px;
      cursor: pointer;
    }

    .client-item:nth-child(odd) {
      background: #F3F4F6;
    }

    .client-item:nth-child(even) {
      background: #E5F0FA;
    }

    .client-item.active {
      outline: 2px solid var(--accent);
      background: var(--accent-soft);
    }

    .client-name {
      font-weight: 600;
    }

    .client-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .actions-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 6px;
    }

    .primary-btn, .ghost-btn {
      border-radius: 999px;
      font-size: 13px;
      padding: 7px 14px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .primary-btn {
      background: var(--accent);
      color: #FFFFFF;
    }

    .primary-btn:disabled {
      background: #9CA3AF;
      cursor: not-allowed;
    }

    .ghost-btn {
      background: transparent;
      color: var(--accent);
      border: 1px solid var(--accent-soft);
    }

    .icon-plus {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1px dashed var(--accent);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: var(--accent);
      cursor: pointer;
    }

    .section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-top: 6px;
    }

    .restruct-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
    }

    .secondary-btn {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--accent);
      background: #FFFFFF;
      font-size: 13px;
      padding: 8px 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      color: var(--accent);
    }

    .secondary-btn.excel {
      border-color: #15803D;
      color: #15803D;
    }

    .restruct-box {
      margin-top: 4px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: #F9FAFB;
      padding: 8px;
      min-height: 130px;
      max-height: 230px;
      overflow-y: auto;
      font-size: 12px;
    }

    .day-block {
      margin-bottom: 6px;
    }

    .day-block-title {
      font-weight: 600;
      color: var(--accent);
      font-size: 12px;
      margin-bottom: 3px;
    }

    .day-client {
      padding-left: 10px;
      line-height: 1.4;
    }

    .footer-note {
      margin-top: 4px;
      font-size: 10px;
      color: var(--text-muted);
    }

    /* Modal nuevo cliente */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .modal {
      width: 90%;
      max-width: 380px;
      background: #FFFFFF;
      border-radius: var(--radius-lg);
      padding: 14px 14px 12px;
      border: 1px solid var(--border);
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.28);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 14px;
      font-weight: 600;
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .modal-fields {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 6px;
    }

    .small {
      font-size: 11px;
    }

    .tag-auto {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #E5F0FA;
      color: var(--accent);
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
<div class="app-shell">
  <!-- Barra superior -->
  <header class="top-bar">
    <div class="top-left">
      <button class="icon-button" id="btnUpload" title="Cargar base (TXT)">
        üìÇ
      </button>
      <input type="file" id="fileInput" accept=".txt" style="display:none">
      <div class="route-box">
        <span class="route-label">Ruta</span>
        <input type="text" id="routeInput" class="route-input" placeholder="17029" />
      </div>
    </div>
    <div class="title">
      REGISTRO DE CLIENTES
    </div>
  </header>

  <!-- Tarjeta principal -->
  <main class="main-card">
    <!-- D√≠a + buscador -->
    <div class="row wrap">
      <div class="day-select-group">
        <div class="row" style="justify-content: space-between; gap:4px;">
          <span class="field-label">D√≠a de visita</span>
          <span class="tag-auto" id="autoDayTag">
            ‚è± Auto: <span id="autoDayName">Lunes</span>
          </span>
        </div>
        <select id="daySelect">
          <option value="1">D√≠a 1 ‚Äî Lunes</option>
          <option value="2">D√≠a 2 ‚Äî Martes</option>
          <option value="3">D√≠a 3 ‚Äî Mi√©rcoles</option>
          <option value="4">D√≠a 4 ‚Äî Jueves</option>
          <option value="5">D√≠a 5 ‚Äî Viernes</option>
          <option value="6">D√≠a 6 ‚Äî S√°bado</option>
        </select>
        <div class="day-info">
          Detecta autom√°ticamente el d√≠a actual, pero puedes cambiarlo para agregar clientes a otro d√≠a.
        </div>
      </div>

      <div class="search-group">
        <label class="field-label" for="searchInput">Buscar cliente</label>
        <input id="searchInput" type="text" placeholder="Ruta, c√≥digo o nombre del negocio‚Ä¶" />
      </div>

      <div style="display:flex;flex-direction:column;align-items:center;gap:4px;margin-top:12px;width:100%;">
        <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
          <span class="field-label">Seleccionar cliente</span>
          <div class="row" style="gap:6px; align-items:center;">
            <span class="small" style="color:var(--text-muted);">Nuevo cliente</span>
            <button class="icon-plus" id="btnNewClient" title="Crear cliente nuevo">+</button>
          </div>
        </div>
        <div class="big-box" id="searchResults">
          <div class="small" style="color:var(--text-muted);">
            Carga la base TXT, selecciona el d√≠a y escribe para buscar por ruta, c√≥digo o nombre.
          </div>
        </div>
        <div class="actions-row">
          <button class="ghost-btn" id="btnClearSelection">
            Limpiar selecci√≥n
          </button>
          <button class="primary-btn" id="btnSaveClient" disabled>
            Guardar en <span id="labelCurrentDay">D√≠a 1 ‚Äî Lunes</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Reestructura -->
    <div class="section-title">Reestructura por d√≠a</div>
    <div class="restruct-row">
      <button class="secondary-btn" id="btnRestructure">
        üß© REESTRUCTURA
      </button>
      <button class="secondary-btn excel" id="btnExportExcel">
        üìä Excel
      </button>
    </div>
    <div class="restruct-box" id="restructOutput">
      <div class="small" style="color:var(--text-muted);">
        Aqu√≠ se mostrar√° la nueva base ordenada por d√≠a:
        DIA 1 LUNES (1,2,3‚Ä¶), DIA 2 MARTES, ‚Ä¶ hasta S√ÅBADO.
      </div>
    </div>
    <div class="footer-note">
      ‚Ä¢ La base original puede venir desordenada y con duplicados; la reestructura dejar√° un solo registro por cliente, ordenado por d√≠a.  
      ‚Ä¢ El archivo Excel seguir√° el mismo orden para compartir la nueva base.
    </div>
  </main>
</div>

<!-- Modal nuevo cliente -->
<div class="modal-backdrop" id="modalBackdrop">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title">Nuevo cliente</div>
        <div class="small" style="color:var(--text-muted);">
          Se asignar√° al <span id="modalDayLabel">D√≠a 1 ‚Äî Lunes</span>.
        </div>
      </div>
      <button class="modal-close" id="btnModalClose">&times;</button>
    </div>
    <div class="modal-fields">
      <div>
        <div class="field-label">Ruta</div>
        <input type="text" id="newRuta" placeholder="Ej. 17029" />
      </div>
      <div>
        <div class="field-label">C√≥digo</div>
        <input type="text" id="newCodigo" placeholder="C√≥digo del cliente" />
      </div>
      <div>
        <div class="field-label">Nombre del negocio</div>
        <input type="text" id="newNombre" placeholder="Tienda, dep√≥sito, etc." />
      </div>
      <div>
        <div class="field-label">Direcci√≥n</div>
        <input type="text" id="newDireccion" placeholder="Direcci√≥n principal" />
      </div>
    </div>
    <div class="modal-actions">
      <button class="ghost-btn small" id="btnModalCancel">Cancelar</button>
      <button class="primary-btn small" id="btnModalSave">Guardar</button>
    </div>
  </div>
</div>

<script>
  // --- Datos en memoria ---
  const dayNames = {
    1: "Lunes",
    2: "Martes",
    3: "Mi√©rcoles",
    4: "Jueves",
    5: "Viernes",
    6: "S√°bado"
  };

  let clientsAll = [];        // Toda la base (TXT + nuevos)
  let selectedDay = 1;        // D√≠a actual para asignar
  let autoDay = 1;            // D√≠a detectado autom√°ticamente
  let selectedClientId = null;
  let lastRestructured = null; // cache √∫ltima reestructura

  function getTodayDayNumber() {
    const d = new Date().getDay(); // 0-domingo, 1-lunes... 6-s√°bado
    switch (d) {
      case 1: return 1; // lunes
      case 2: return 2;
      case 3: return 3;
      case 4: return 4;
      case 5: return 5;
      case 6: return 6; // s√°bado
      default: return 1; // domingo -> tratar como d√≠a 1
    }
  }

  function updateDayLabels() {
    const labelCurrentDay = document.getElementById("labelCurrentDay");
    const modalDayLabel = document.getElementById("modalDayLabel");
    const autoDayName = document.getElementById("autoDayName");

    autoDayName.textContent = dayNames[autoDay] || "Lunes";

    const text = `D√≠a ${selectedDay} ‚Äî ${dayNames[selectedDay] || ""}`;
    labelCurrentDay.textContent = text;
    modalDayLabel.textContent = text;
  }

  function renderSearchResults() {
    const container = document.getElementById("searchResults");
    const searchInput = document.getElementById("searchInput");
    const term = searchInput.value.trim().toLowerCase();
    container.innerHTML = "";

    if (!clientsAll.length) {
      container.innerHTML = '<div class="small" style="color:#6B7280;">Carga primero la base TXT para buscar clientes.</div>';
      return;
    }

    const filtered = term
      ? clientsAll.filter(c => {
          return (
            (c.ruta && String(c.ruta).toLowerCase().includes(term)) ||
            (c.codigo && String(c.codigo).toLowerCase().includes(term)) ||
            (c.nombre && c.nombre.toLowerCase().includes(term))
          );
        })
      : clientsAll;

    if (!filtered.length) {
      container.innerHTML = '<div class="small" style="color:#6B7280;">Sin resultados para esa b√∫squeda.</div>';
      return;
    }

    filtered.forEach(c => {
      const item = document.createElement("div");
      item.className = "client-item";
      item.dataset.id = c.id;

      if (c.id === selectedClientId) {
        item.classList.add("active");
      }

      const nombre = document.createElement("div");
      nombre.className = "client-name";
      nombre.textContent = c.nombre || "(Sin nombre)";

      const meta = document.createElement("div");
      meta.className = "client-meta";
      meta.textContent =
        `Ruta ${c.ruta || "-"} | C√≥digo ${c.codigo || "-"} | D√≠a ${c.day || "-"} ${dayNames[c.day] || ""}`;

      item.appendChild(nombre);
      item.appendChild(meta);

      item.addEventListener("click", () => {
        selectedClientId = c.id;
        updateSaveButtonState();
        renderSearchResults(); // refrescar para marcar activo
      });

      container.appendChild(item);
    });
  }

  function updateSaveButtonState() {
    const btn = document.getElementById("btnSaveClient");
    btn.disabled = !selectedClientId;
  }

  function restructureBase() {
    // Deduplicar por c√≥digo (o nombre+direcci√≥n si no hay c√≥digo) y agrupar por d√≠a
    const uniqueMap = new Map();

    // Recorremos al rev√©s para que el √∫ltimo cambio sea el que manda
    for (let i = clientsAll.length - 1; i >= 0; i--) {
      const c = clientsAll[i];
      const key =
        (c.codigo && String(c.codigo).trim()) ||
        (c.nombre || "") + "|" + (c.direccion || "");
      if (!key.trim()) continue;

      if (!uniqueMap.has(key)) {
        // Asegurar d√≠a v√°lido
        let day = parseInt(c.day, 10);
        if (!day || day < 1 || day > 6) {
          day = 1;
        }
        uniqueMap.set(key, { ...c, day });
      }
    }

    const grouped = { 1: [], 2: [], 3: [], 4: [], 5: [], 6: [] };
    for (const [, client] of uniqueMap) {
      const d = client.day || 1;
      grouped[d].push(client);
    }

    // Podemos ordenar por nombre
    for (let d = 1; d <= 6; d++) {
      grouped[d].sort((a, b) => {
        const na = (a.nombre || "").toLowerCase();
        const nb = (b.nombre || "").toLowerCase();
        return na.localeCompare(nb, "es");
      });
    }

    lastRestructured = grouped;
    renderRestructured(grouped);
  }

  function renderRestructured(grouped) {
    const container = document.getElementById("restructOutput");
    container.innerHTML = "";

    let hasContent = false;

    for (let d = 1; d <= 6; d++) {
      const clients = grouped[d] || [];
      if (!clients.length) continue;
      hasContent = true;

      const block = document.createElement("div");
      block.className = "day-block";

      const title = document.createElement("div");
      title.className = "day-block-title";
      title.textContent = `DIA ${d} ${dayNames[d]?.toUpperCase() || ""}`;
      block.appendChild(title);

      clients.forEach((c, idx) => {
        const row = document.createElement("div");
        row.className = "day-client";
        row.textContent =
          `${idx + 1}. ${c.nombre || "(Sin nombre)"} ‚Äî Ruta ${c.ruta || "-"} | C√≥digo ${c.codigo || "-"}`;
        block.appendChild(row);
      });

      container.appendChild(block);
    }

    if (!hasContent) {
      container.innerHTML =
        '<div class="small" style="color:#6B7280;">No hay datos para reestructurar. Carga la base y/o agrega clientes.</div>';
    }
  }

  function exportToExcelLike() {
    if (!lastRestructured) {
      restructureBase();
    }
    if (!lastRestructured) return;

    let csv = "DIA;ORDEN;RUTA;CODIGO;NOMBRE;DIRECCION\n";

    for (let d = 1; d <= 6; d++) {
      const clients = lastRestructured[d] || [];
      if (!clients.length) continue;

      clients.forEach((c, idx) => {
        const row = [
          `DIA ${d} ${dayNames[d] || ""}`,
          idx + 1,
          c.ruta || "",
          c.codigo || "",
          (c.nombre || "").replace(/;/g, ","),
          (c.direccion || "").replace(/;/g, ",")
        ];
        csv += row.join(";") + "\n";
      });
    }

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "Base_clientes_reestructurada.csv"; // Excel lo abre sin problemas
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  function openModal() {
    const backdrop = document.getElementById("modalBackdrop");
    backdrop.style.display = "flex";
  }

  function closeModal() {
    const backdrop = document.getElementById("modalBackdrop");
    backdrop.style.display = "none";
    document.getElementById("newRuta").value = document.getElementById("routeInput").value || "";
    document.getElementById("newCodigo").value = "";
    document.getElementById("newNombre").value = "";
    document.getElementById("newDireccion").value = "";
  }

  function saveNewClientFromModal() {
    const ruta = document.getElementById("newRuta").value.trim() || document.getElementById("routeInput").value.trim();
    const codigo = document.getElementById("newCodigo").value.trim();
    const nombre = document.getElementById("newNombre").value.trim();
    const direccion = document.getElementById("newDireccion").value.trim();

    if (!nombre) {
      alert("El nombre del negocio es obligatorio.");
      return;
    }

    const newClient = {
      id: "new-" + Date.now() + "-" + Math.random().toString(16).slice(2),
      ruta: ruta || "",
      codigo,
      nombre,
      direccion,
      day: selectedDay
    };

    clientsAll.push(newClient);
    closeModal();
    renderSearchResults();
    restructureBase();
  }

  function handleSaveClientToDay() {
    if (!selectedClientId) return;
    const client = clientsAll.find(c => c.id === selectedClientId);
    if (!client) return;

    client.day = selectedDay;
    restructureBase();
    alert(`Cliente asignado a D√≠a ${selectedDay} ‚Äî ${dayNames[selectedDay] || ""}.`);
  }

  function parseTxtFile(content) {
    const lines = content.split(/\r?\n/);
    clientsAll = [];

    lines.forEach((line, index) => {
      const trimmed = line.trim();
      if (!trimmed) return;

      // Formato asumido: RUTA;CODIGO;NOMBRE;DIRECCION;DIA
      const parts = trimmed.split(";");
      const ruta = (parts[0] || "").trim();
      const codigo = (parts[1] || "").trim();
      const nombre = (parts[2] || "").trim();
      const direccion = (parts[3] || "").trim();
      let day = parseInt((parts[4] || "").trim(), 10);

      if (!day || day < 1 || day > 6) {
        day = 1; // si no viene d√≠a, asignamos D√≠a 1 (lunes) por defecto
      }

      const client = {
        id: `base-${index}`,
        ruta,
        codigo,
        nombre,
        direccion,
        day
      };

      clientsAll.push(client);
    });

    renderSearchResults();
    restructureBase();
  }

  // --- Eventos iniciales ---
  document.addEventListener("DOMContentLoaded", () => {
    autoDay = getTodayDayNumber();
    selectedDay = autoDay;

    document.getElementById("daySelect").value = String(selectedDay);
    updateDayLabels();

    document.getElementById("btnUpload").addEventListener("click", () => {
      document.getElementById("fileInput").click();
    });

    document.getElementById("fileInput").addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        parseTxtFile(ev.target.result);
      };
      reader.readAsText(file, "utf-8");
    });

    document.getElementById("daySelect").addEventListener("change", (e) => {
      selectedDay = parseInt(e.target.value, 10) || 1;
      updateDayLabels();
    });

    document.getElementById("searchInput").addEventListener("input", () => {
      selectedClientId = null;
      updateSaveButtonState();
      renderSearchResults();
    });

    document.getElementById("btnClearSelection").addEventListener("click", () => {
      selectedClientId = null;
      updateSaveButtonState();
      renderSearchResults();
    });

    document.getElementById("btnSaveClient").addEventListener("click", handleSaveClientToDay);
    document.getElementById("btnRestructure").addEventListener("click", restructureBase);
    document.getElementById("btnExportExcel").addEventListener("click", exportToExcelLike);

    // Modal nuevo cliente
    document.getElementById("btnNewClient").addEventListener("click", openModal);
    document.getElementById("btnModalClose").addEventListener("click", closeModal);
    document.getElementById("btnModalCancel").addEventListener("click", closeModal);
    document.getElementById("btnModalSave").addEventListener("click", saveNewClientFromModal);

    document.getElementById("modalBackdrop").addEventListener("click", (e) => {
      if (e.target.id === "modalBackdrop") {
        closeModal();
      }
    });
  });
</script>
</body>
</html>
