<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Registro de Clientes 2</title>
  <style>
    :root {
      --bg: #E5E7EB;
      --card: #FFFFFF;
      --accent: #0F5C9A;
      --accent-soft: #E3ECF5;
      --border: #D1D5DB;
      --text-main: #111827;
      --text-soft: #6B7280;
      --danger: #B91C1C;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: var(--bg);
      color: var(--text-main);
    }

    .app-shell {
      width: 100%;
      max-width: 420px;
      margin: 0 auto 64px;
      padding: 0 4px;
    }

    h1 {
      font-size: 20px;
      font-weight: 600;
      margin: 0 0 12px;
      color: var(--text-main);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      font-size: 11px;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .card {
      overflow: hidden;
      background: var(--card);
      border-radius: 18px;
      padding: 16px 18px;
      box-shadow: 0 8px 18px rgba(15, 76, 129, 0.08);
      margin-bottom: 14px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 12px;
      gap: 12px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: var(--text-soft);
    }

    .field-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .field {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-soft);
      font-weight: 600;
    }

    .input-shell {
      display: flex;
      align-items: center;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #F9FAFB;
      padding: 0 12px;
      height: 44px;
      gap: 8px;
    }

    .input-shell input,
    .input-shell select {
      border: none;
      outline: none;
      background: transparent;
      flex: 1;
      font-size: 14px;
      color: var(--text-main);
    }

    .input-shell select {
      -webkit-appearance: none;
      appearance: none;
      padding-right: 18px;
    }

    .icon-folder {
      width: 26px;
      height: 26px;
      border-radius: 9px;
      background: linear-gradient(135deg, #FBBF24, #F97316);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-size: 16px;
    }

    .chevron {
      font-size: 13px;
      color: var(--text-soft);
    }

    .search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .search-input-shell {
      flex: 1;
      display: flex;
      align-items: center;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #F9FAFB;
      padding: 0 12px;
      height: 46px;
      gap: 8px;
    }

    .search-input-shell input {
      border: none;
      outline: none;
      background: transparent;
      flex: 1;
      font-size: 14px;
    }

    .search-input-shell .search-icon {
      font-size: 16px;
      color: var(--text-soft);
    }

    .btn {
      border-radius: 12px;
      border: none;
      padding: 0 16px;
      height: 44px;
      font-size: 14px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.05s ease, background 0.15s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: var(--accent);
      color: #fff;
      width: 100%;
      box-shadow: 0 6px 14px rgba(15, 92, 154, 0.25);
    }

    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 3px 7px rgba(15, 92, 154, 0.2);
    }

    .btn-secondary {
      background: #EEF0F4;
      color: var(--text-main);
    }

    .btn-icon {
      width: 44px;
      padding: 0;
      border-radius: 12px;
      background: var(--accent);
      color: #fff;
      font-size: 22px;
      box-shadow: 0 5px 10px rgba(15, 92, 154, 0.25);
    }

    .helper-text {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .status-text {
      font-size: 12px;
      margin-top: 6px;
      color: var(--text-soft);
    }

    .status-text strong {
      color: var(--text-main);
    }

    .status-error {
      color: var(--danger);
    }

    .status-ok {
      color: #047857;
    }

    .bottom-actions {
      margin-top: 12px;
    }

    .toggle-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 12px;
    }

    .toggle-shell {
      width: 56px;
      height: 30px;
      border-radius: 999px;
      background: #E5E7EB;
      display: flex;
      align-items: center;
      padding: 3px;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .toggle-shell.active {
      background: var(--accent);
    }

    .toggle-knob {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      transform: translateX(0);
      transition: transform 0.15s ease;
    }

    .toggle-shell.active .toggle-knob {
      transform: translateX(24px);
    }

    .icon-trash {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: var(--text-soft);
      background: #F9FAFB;
      cursor: pointer;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.05s ease;
    }

    .icon-trash.active-trash {
      background: #FEE2E2;
      border-color: #F97316;
      transform: scale(0.96);
    }

    .bottom-buttons {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }

    .bottom-buttons .btn {
      flex: 1;
      height: 44px;
    }

    .btn-ghost {
      background: #F9FAFB;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 13px;
      font-weight: 600;
      color: var(--text-main);
    }

    #tablaWrapper {
      width: 100%;
      max-width: 100%;
      overflow-x: auto;
    }

    table {
      width: 100%;
      max-width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 11px;
      table-layout: fixed;
    }

    thead {
      background: var(--accent-soft);
    }

    th, td {
      padding: 6px 4px;
      text-align: left;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    th {
      font-weight: 600;
      color: var(--text-soft);
      border-bottom: 1px solid var(--border);
    }

    tbody tr:nth-child(even) {
      background: #F9FAFB;
    }

    .no-data {
      font-size: 11px;
      color: var(--text-soft);
      margin-top: 8px;
    }

    .suggestions {
      margin-top: 4px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #FFFFFF;
      max-height: 150px;
      overflow-y: auto;
      font-size: 12px;
    }

    .suggestions-item {
      padding: 8px 12px;
      cursor: pointer;
      font-size: 14px;
    }

    .suggestions-item:hover {
      background: #EEF2FF;
    }

    .badge-selected {
      display: inline-flex;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: var(--accent-soft);
      color: var(--accent);
      margin-top: 4px;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal {
      background: #FFFFFF;
      border-radius: 18px;
      padding: 16px 18px 14px;
      width: min(420px, 92vw);
      box-shadow: 0 14px 32px rgba(15, 23, 42, 0.35);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .modal-title {
      font-size: 15px;
      font-weight: 600;
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 20px;
      cursor: pointer;
      color: var(--text-soft);
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .modal-actions .btn {
      flex: 1;
      height: 40px;
      font-size: 13px;
    }

    @media (max-width: 480px) {
      html, body {
        width: 100%;
        overflow-x: hidden;
        touch-action: manipulation;
      }
      body {
        padding: 12px;
      }
      .app-shell {
        padding: 0 6px;
      }
      .card {
        padding: 13px 14px;
      }
      h1 {
        font-size: 18px;
      }
      .input-shell, .search-input-shell {
        height: 40px;
      }
      .btn-primary {
        height: 42px;
        font-size: 13px;
      }
      .btn-icon {
        width: 40px;
        height: 40px;
        font-size: 20px;
      }
      table {
        font-size: 10px;
      }
      th, td {
        padding: 4px 2px;
      }
      .bottom-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
<div class="app-shell">
  <!-- Texto ocultado seg√∫n solicitud -->
  <h1>Registro de Clientes</h1>

  <!-- CARD RUTA / D√çA -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">Datos de visita</span>
    </div>
    <div class="field-row">
      <div class="field">
        <label class="field-label">Ruta</label>
        <div class="input-shell" id="rutaInputShell">
          <div class="icon-folder" title="Cargar base .txt">
            &#x1F4C2;
          </div>
          <input id="ruta" type="number" value="17029" min="0" />
        </div>
        <div class="helper-text">
          La ruta se usar√° en todos los clientes guardados.
        </div>
      </div>
      <div class="field">
        <label class="field-label">D√≠a</label>
        <div class="input-shell">
          <select id="dia">
            <option value="Lunes">Lunes</option>
            <option value="Martes">Martes</option>
            <option value="Mi√©rcoles">Mi√©rcoles</option>
            <option value="Jueves">Jueves</option>
            <option value="Viernes" selected>Viernes</option>
            <option value="S√°bado">S√°bado</option>
            <option value="Domingo">Domingo</option>
          </select>
          <span class="chevron">‚ñæ</span>
        </div>
        <div class="helper-text">
          D√≠a de visita para la reestructura.
        </div>
      </div>
    </div>
  </div>

  <!-- CARD BUSCAR / GUARDAR -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">Selecci√≥n de cliente</span>
    </div>

    <div class="search-row">
      <div class="search-input-shell">
        <span class="search-icon">üîç</span>
        <input id="buscador" type="text" placeholder="Buscar por c√≥digo, negocio o cliente" autocomplete="off" />
      </div>
      <button class="btn btn-icon" id="btnNuevo" title="Crear cliente nuevo">+</button>
    </div>

    <div id="suggestions" class="suggestions" style="display:none;"></div>

    <div class="helper-text"></div>
    <div id="estadoSeleccion" class="status-text" style="display:none;"></div>
    <div id="estadoCarga" class="status-text"></div>
    <div id="estadoError" class="status-text status-error"></div>

    <div class="bottom-actions">
      <button class="btn btn-primary" id="btnGuardar">GUARDAR</button>
    </div>
  </div>

  <!-- CARD TABLA REESTRUCTURADA -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">Tabla reestructurada</span>
    </div>
    <div class="helper-text">
      Presione <strong>Reestructura</strong> para ver los clientes organizados por d√≠a y orden de visita.
    </div>

    <div class="toggle-row">
      <div id="toggleSoloGuardados" class="toggle-shell active">
        <div class="toggle-knob"></div>
      </div>
      <span class="helper-text">Mostrar solo clientes guardados.</span>
      <div id="btnLimpiarTodo" class="icon-trash" title="Borrar todo">üóë</div>
      <div id="estadoLimpieza" class="status-text"></div>
    </div>

    <div class="bottom-buttons">
      <button class="btn btn-ghost" id="btnExcel">EXCEL</button>
      <button class="btn btn-primary" id="btnReestructura">REESTRUCTURA</button>
    </div>

    <div id="tablaWrapper">
      <div class="no-data">Sin datos reestructurados todav√≠a.</div>
    </div>
  </div>
</div>

<!-- INPUT OCULTO PARA TXT -->
<input type="file" id="fileInput" accept=".txt" style="display:none;" />

<!-- MODAL NUEVO CLIENTE -->
<div class="modal-backdrop" id="modalNuevo">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Nuevo cliente</div>
      <button class="modal-close" id="modalCerrar">&times;</button>
    </div>
    <div class="helper-text">
      Los datos del nuevo cliente se guardar√°n tambi√©n en la base local de la app.
    </div>

    <div class="field" style="margin-top:10px;">
      <label class="field-label">C√≥digo Negocio</label>
      <div class="input-shell">
        <input id="nuevoCodigo" type="text" />
      </div>
    </div>

    <div class="field">
      <label class="field-label">Nombre Negocio</label>
      <div class="input-shell">
        <input id="nuevoNombreNegocio" type="text" />
      </div>
    </div>
    <div class="field">
      <label class="field-label">Nombre Cliente</label>
      <div class="input-shell">
        <input id="nuevoNombreCliente" type="text" />
      </div>
    </div>
    <div class="field">
      <label class="field-label">Direcci√≥n</label>
      <div class="input-shell">
        <input id="nuevoDireccion" type="text" />
      </div>
    </div>
    <div class="field">
      <label class="field-label">Nit Facturaci√≥n</label>
      <div class="input-shell">
        <input id="nuevoNit" type="text" placeholder="CF" />
      </div>
    </div>

    <div class="modal-actions">
      <button class="btn btn-secondary" id="modalCancelar">Cancelar</button>
      <button class="btn btn-primary" id="modalGuardar">Guardar</button>
    </div>
    <div id="modalError" class="status-text status-error"></div>
  </div>
</div>

<script>
  // ============================
  // ESTADO GLOBAL
  // ============================
  let baseClientes = [];
  let clienteSeleccionado = null;
  let registrosGuardados = [];
  const STORAGE_KEY = "registroClientes2_registros";
  const STORAGE_BASE = "registroClientes2_base";

  // ============================
  // UTILIDADES
  // ============================
  function normalizarTexto(t) {
    return (t || "")
      .toString()
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "");
  }

  function cargarDesdeLocalStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      registrosGuardados = raw ? JSON.parse(raw) : [];
    } catch (e) {
      registrosGuardados = [];
    }
    try {
      const rawBase = localStorage.getItem(STORAGE_BASE);
      baseClientes = rawBase ? JSON.parse(rawBase) : [];
    } catch (e) {
      baseClientes = [];
    }
    actualizarEstadoCarga();
  }

  function guardarEnLocalStorage() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(registrosGuardados));
    localStorage.setItem(STORAGE_BASE, JSON.stringify(baseClientes));
  }

  function actualizarEstadoCarga() {
    const estadoCarga = document.getElementById("estadoCarga");
    if (baseClientes.length === 0) {
      estadoCarga.textContent = "Sin base de datos cargada.";
      estadoCarga.className = "status-text";
    } else {
      estadoCarga.textContent = `Base de datos con ${baseClientes.length} clientes.`;
      estadoCarga.className = "status-text status-ok";
    }
  }

  function mostrarError(msg) {
    const el = document.getElementById("estadoError");
    el.textContent = msg || "";
  }

  function actualizarEstadoSeleccion() {
    const estado = document.getElementById("estadoSeleccion");
    if (!estado) return;
    if (!clienteSeleccionado) {
      estado.style.display = "none";
      estado.innerHTML = "";
      return;
    }
    estado.style.display = "block";
    estado.innerHTML = `
      <span>Cliente seleccionado:</span>
      <div class="badge-selected">${clienteSeleccionado.codigo} ¬∑ ${clienteSeleccionado.nombreNegocio}</div>
    `;
  }

  // ============================
  // PARSEO DEL TXT
  // ============================
  function parsearTxtClientes(text) {
    // TXT en formato vertical de 5 l√≠neas por cliente
    const rawLines = text
      .split(/\r?\n/)
      .map(l => l.trim());

    const lineas = rawLines.filter(l => l.length > 0);

    console.log("[DEBUG] L√≠neas no vac√≠as en TXT:", lineas.length);
    if (lineas.length < 5) return [];

    const clientes = [];

    for (let i = 0; i + 4 < lineas.length; i += 5) {
      const codigo        = lineas[i] || "";
      const nombreNegocio = lineas[i + 1] || "";
      const nombreCliente = lineas[i + 2] || "";
      const direccion     = lineas[i + 3] || "";
      const nit           = (lineas[i + 4] || "CF").toUpperCase();

      if (!codigo || !nombreNegocio) continue;

      clientes.push({
        codigo: codigo.trim(),
        nombreNegocio: nombreNegocio.trim(),
        nombreCliente: nombreCliente.trim(),
        direccion: direccion.trim(),
        nit: nit.trim() || "CF",
      });
    }

    console.log("[DEBUG] Clientes reconocidos:", clientes.length);
    return clientes;
  }

  // ============================
  // SUGERENCIAS DE B√öSQUEDA
  // ============================
  function actualizarSugerencias() {
    const q = normalizarTexto(document.getElementById("buscador").value);
    const cont = document.getElementById("suggestions");
    cont.innerHTML = "";
    if (!q || baseClientes.length === 0) {
      cont.style.display = "none";
      return;
    }
    const resultados = baseClientes
      .filter(c => {
        const nc = normalizarTexto(c.codigo);
        const nn = normalizarTexto(c.nombreNegocio);
        const np = normalizarTexto(c.nombreCliente);
        return nc.includes(q) || nn.includes(q) || np.includes(q);
      })
      .slice(0, 30);

    if (resultados.length === 0) {
      cont.style.display = "none";
      return;
    }

    resultados.forEach(c => {
      const div = document.createElement("div");
      div.className = "suggestions-item";
      div.textContent = `${c.codigo} ¬∑ ${c.nombreNegocio} ¬∑ ${c.nombreCliente}`;
      div.onclick = () => {
        clienteSeleccionado = { ...c };
        document.getElementById("buscador").value = c.nombreNegocio;
        cont.style.display = "none";
        actualizarEstadoSeleccion();
        mostrarError("");
      };
      cont.appendChild(div);
    });

    cont.style.display = "block";
  }

  // ============================
  // TABLA REESTRUCTURADA
  // ============================
  function construirTabla() {
    const wrapper = document.getElementById("tablaWrapper");
    const ruta = document.getElementById("ruta").value.trim();
    const dia = document.getElementById("dia").value;
    const soloGuardados = document
      .getElementById("toggleSoloGuardados")
      .classList.contains("active");

    let datos = [...registrosGuardados];

    if (soloGuardados) {
      datos = datos.filter(r => r.ruta === ruta && r.diaVisita === dia);
    }

    if (datos.length === 0) {
      wrapper.innerHTML =
        '<div class="no-data">Sin datos reestructurados para la ruta y d√≠a actuales.</div>';
      return;
    }

    datos.sort((a, b) => {
      if (a.diaVisita !== b.diaVisita) return a.diaVisita.localeCompare(b.diaVisita);
      return (a.orden || 0) - (b.orden || 0);
    });

    // Tabla RESUMEN en la app (solo columnas clave)
    let html = `<table>
      <thead>
        <tr>
          <th>Ruta</th>
          <th>D√≠a</th>
          <th>Orden</th>
          <th>C√≥digo</th>
          <th>Negocio</th>
        </tr>
      </thead>
      <tbody>`;

    for (const r of datos) {
      html += `
        <tr>
          <td>${r.ruta}</td>
          <td>${r.diaVisita}</td>
          <td>${r.orden}</td>
          <td>${r.codigo}</td>
          <td>${r.nombreNegocio}</td>
        </tr>
      `;
    }

    html += "</tbody></table>";
    wrapper.innerHTML = html;
  }

  // ============================
  // EXPORTAR EXCEL (CSV)
  // ============================
  function descargarExcel() {
    const ruta = document.getElementById("ruta").value.trim();
    const dia = document.getElementById("dia").value;
    let datos = registrosGuardados.filter(
      r => r.ruta === ruta && r.diaVisita === dia
    );

    if (datos.length === 0) {
      alert("No hay datos para exportar en la ruta y d√≠a actuales.");
      return;
    }

    datos.sort((a, b) => (a.orden || 0) - (b.orden || 0));

    const encabezados = [
      "Ruta",
      "D√≠a Visita",
      "Orden",
      "C√≥digo Negocio",
      "Nombre Negocio",
      "Nombre Cliente",
      "Direcci√≥n",
      "Nit Facturaci√≥n"
    ];

    const filas = [encabezados];

    datos.forEach(r => {
      filas.push([
        r.ruta,
        (r.diaVisita || "").toString().toUpperCase(),
        r.orden,
        r.codigo,
        r.nombreNegocio,
        r.nombreCliente,
        r.direccion,
        r.nit
      ]);
    });

    // Generar CSV con separador ";" (formato t√≠pico de Excel en espa√±ol)
    const csv = filas
      .map(row => row
        .map(v => {
          const value = (v || "").toString().replace(/"/g, '""');
          return `"${value}"`;
        })
        .join(";"))
      .join("\r\n");

    const blob = new Blob([csv], {
      type: "text/csv;charset=utf-8;"
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `restructura_r${ruta}_${dia}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ============================
  // GUARDAR REGISTRO
  // ============================
  function guardarRegistro() {
    mostrarError("");
    const ruta = document.getElementById("ruta").value.trim();
    const dia = document.getElementById("dia").value;

    if (!ruta) {
      mostrarError("Ingrese la ruta.");
      return;
    }
    if (!clienteSeleccionado) {
      mostrarError("Seleccione o cree un cliente antes de guardar.");
      return;
    }

    const existentes = registrosGuardados.filter(
      r => r.ruta === ruta && r.diaVisita === dia
    );
    const orden = existentes.length + 1;

    const registro = {
      ruta,
      diaVisita: dia,
      orden,
      codigo: clienteSeleccionado.codigo,
      nombreNegocio: clienteSeleccionado.nombreNegocio,
      nombreCliente: clienteSeleccionado.nombreCliente,
      direccion: clienteSeleccionado.direccion,
      nit: clienteSeleccionado.nit || "CF"
    };

    registrosGuardados.push(registro);
    guardarEnLocalStorage();
    actualizarEstadoSeleccion();
    construirTabla();

    document.getElementById("buscador").value = "";
    clienteSeleccionado = null;
    actualizarEstadoSeleccion();
  }

  // ============================
  // MODAL NUEVO CLIENTE
  // ============================
  function abrirModalNuevo() {
    document.getElementById("modalNuevo").style.display = "flex";
    document.getElementById("modalError").textContent = "";
    document.getElementById("nuevoCodigo").value = "";
    document.getElementById("nuevoNombreNegocio").value = "";
    document.getElementById("nuevoNombreCliente").value = "";
    document.getElementById("nuevoDireccion").value = "";
    document.getElementById("nuevoNit").value = "CF";
  }

  function cerrarModalNuevo() {
    document.getElementById("modalNuevo").style.display = "none";
  }

  function guardarNuevoCliente() {
    const codigo = document.getElementById("nuevoCodigo").value.trim();
    const nombreNegocio = document
      .getElementById("nuevoNombreNegocio")
      .value.trim();
    const nombreCliente = document
      .getElementById("nuevoNombreCliente")
      .value.trim();
    const direccion = document
      .getElementById("nuevoDireccion")
      .value.trim();
    const nit = (document.getElementById("nuevoNit").value.trim() || "CF").toUpperCase();
    const errEl = document.getElementById("modalError");

    if (!codigo || !nombreNegocio) {
      errEl.textContent = "C√≥digo y nombre del negocio son obligatorios.";
      return;
    }

    const existente = baseClientes.find(c => c.codigo === codigo);
    if (existente) {
      errEl.textContent = "Ya existe un cliente con ese c√≥digo en la base.";
      return;
    }

    const nuevo = { codigo, nombreNegocio, nombreCliente, direccion, nit };
    baseClientes.push(nuevo);
    clienteSeleccionado = { ...nuevo };
    guardarEnLocalStorage();
    actualizarEstadoCarga();
    actualizarEstadoSeleccion();
    document.getElementById("buscador").value = nombreNegocio;
    cerrarModalNuevo();
  }

  // ============================
  // LIMPIAR REGISTROS
  // ============================
  function limpiarRegistros() {
    const ruta = document.getElementById("ruta").value.trim();
    const dia = document.getElementById("dia").value;

    // Mensaje claro: solo se borran los registros de la ruta y d√≠a actuales
    const mensaje = ruta
      ? `Se borrar√°n todos los registros guardados de la ruta ${ruta} para el d√≠a ${dia}. ¬øDesea continuar?`
      : `Se borrar√°n todos los registros guardados para el d√≠a ${dia}. ¬øDesea continuar?`;

    if (!confirm(mensaje)) return;

    // Elimina SOLO los registros de la tabla actual (ruta + d√≠a seleccionados)
    registrosGuardados = registrosGuardados.filter(
      r => !(r.ruta === ruta && r.diaVisita === dia)
    );

    guardarEnLocalStorage();
    construirTabla();

    const msg = document.getElementById("estadoLimpieza");
    if (msg) {
      msg.textContent = "Registros de la tabla actual eliminados correctamente.";
      msg.className = "status-text status-ok";
      setTimeout(() => {
        msg.textContent = "";
      }, 3000);
    }

    const trash = document.getElementById("btnLimpiarTodo");
    if (trash) {
      trash.classList.add("active-trash");
      setTimeout(() => trash.classList.remove("active-trash"), 180);
    }
  }

  // ============================
  // TESTS B√ÅSICOS (CONSOLE)
  // ============================
  function runTests() {
    console.group("Tests RegistroClientes2");

    // Test 1: un cliente en formato vertical 5 l√≠neas
    const txt1 = [
      "2000-1018349",
      "TIENDA LA BENDICION #3",
      "DIEGO TOJIN",
      "EL PROGRESO-SANARATE, 5 AVENIDA ZONA 2",
      "CF"
    ].join("\n");
    const r1 = parsearTxtClientes(txt1);
    console.assert(r1.length === 1, "Test1: deber√≠a haber 1 cliente");
    console.assert(r1[0].codigo === "2000-1018349", "Test1: c√≥digo coincide");
    console.assert(r1[0].nit === "CF", "Test1: nit coincide");

    // Test 2: dos clientes seguidos (10 l√≠neas)
    const txt2 = [
      "2000-1165850",
      "TIENDA ESQUIPULAS",
      "RICARDO UZ",
      "EL PROGRESO-SANARATE, 3 AVENIDA 1-003 ZONA 1",
      "9430824-1",
      "2000-1191342",
      "TIENDA LA BENDICION DE DIOS EL CIELITO",
      "GASPAR TIU",
      "SANARATE, ZONA 2, 05 CL. 8071, SANARATE, EL PROGRESO",
      "8345398-9"
    ].join("\n");
    const r2 = parsearTxtClientes(txt2);
    console.assert(r2.length === 2, "Test2: deber√≠a haber 2 clientes");
    console.assert(r2[1].codigo === "2000-1191342", "Test2: c√≥digo segundo cliente");

    // Test 3: archivo vac√≠o
    const r3 = parsearTxtClientes("");
    console.assert(r3.length === 0, "Test3: sin clientes en texto vac√≠o");

    // Test 4: bloque incompleto (7 l√≠neas -> solo 1 cliente v√°lido)
    const txt4 = [
      "2000-5555555",
      "TIENDA PRUEBA",
      "JUAN PEREZ",
      "GUATEMALA, ZONA 1",
      "CF",
      "CODIGO-INCOMPLETO",
      "SOLO DOS LINEAS"
    ].join("\n");
    const r4 = parsearTxtClientes(txt4);
    console.assert(r4.length === 1, "Test4: solo 1 cliente v√°lido por bloque completo");

    console.groupEnd();
  }

  // ============================
  // INICIALIZACI√ìN
  // ============================
  window.addEventListener("DOMContentLoaded", () => {
    cargarDesdeLocalStorage();
    actualizarEstadoSeleccion();
    construirTabla();
    runTests();

    document
      .getElementById("buscador")
      .addEventListener("input", actualizarSugerencias);
    document
      .getElementById("btnGuardar")
      .addEventListener("click", guardarRegistro);
    document
      .getElementById("btnReestructura")
      .addEventListener("click", construirTabla);
    document
      .getElementById("btnExcel")
      .addEventListener("click", descargarExcel);

    document
      .getElementById("rutaInputShell")
      .addEventListener("click", e => {
        const isIcon = e.target.closest(".icon-folder");
        if (isIcon) {
          document.getElementById("fileInput").click();
        }
      });

    document
      .getElementById("fileInput")
      .addEventListener("change", e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = evt => {
          try {
            const contenido = evt.target.result;
            const clientes = parsearTxtClientes(contenido);
            if (clientes.length === 0) {
              mostrarError("No se reconocieron clientes en el archivo .txt.");
              return;
            }
            baseClientes = clientes;
            guardarEnLocalStorage();
            actualizarEstadoCarga();
            mostrarError("");
          } catch (err) {
            console.error(err);
            mostrarError("Error al leer el archivo .txt.");
          }
        };
        reader.readAsText(file, "utf-8");
      });

    document
      .getElementById("toggleSoloGuardados")
      .addEventListener("click", () => {
        const t = document.getElementById("toggleSoloGuardados");
        t.classList.toggle("active");
        construirTabla();
      });

    document
      .getElementById("btnLimpiarTodo")
      .addEventListener("click", limpiarRegistros);

    document
      .getElementById("btnNuevo")
      .addEventListener("click", abrirModalNuevo);
    document
      .getElementById("modalCerrar")
      .addEventListener("click", cerrarModalNuevo);
    document
      .getElementById("modalCancelar")
      .addEventListener("click", cerrarModalNuevo);
    document
      .getElementById("modalGuardar")
      .addEventListener("click", guardarNuevoCliente);

    document
      .getElementById("modalNuevo")
      .addEventListener("click", e => {
        if (e.target.id === "modalNuevo") cerrarModalNuevo();
      });
  });
</script>
</body>
</html>
