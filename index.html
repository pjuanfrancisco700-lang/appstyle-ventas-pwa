<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <title>Registro de Clientes</title>
  <style>
    :root {
      --bg: #F4F5F7;
      --card: #FFFFFF;
      --primary: #0F3B5F;   /* toque SAP */
      --primary-soft: #D8E3F0;
      --border: #D0D4DD;
      --text-main: #111827;
      --text-muted: #6B7280;
      --accent: #2563EB;
      --danger: #B91C1C;
      --shadow-soft: 0 6px 18px rgba(15, 59, 95, 0.08);
      --radius-lg: 16px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      padding: 12px 8px 24px;
    }

    .app-shell {
      width: 100%;
      max-width: 480px;
      background: linear-gradient(to bottom, #F9FAFB, #EEF1F5);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      padding: 10px 10px 18px;
      border: 1px solid rgba(15,59,95,0.06);
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--card);
      border-radius: 18px;
      padding: 8px 10px;
      border: 1px solid rgba(15,59,95,0.06);
      margin-bottom: 10px;
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
    }

    .file-label {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 34px;
      height: 34px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--primary-soft);
      color: var(--primary);
      font-size: 18px;
      cursor: pointer;
      flex-shrink: 0;
    }

    .file-label span {
      transform: translateY(-1px);
    }

    #dbInput {
      display: none;
    }

    .route-input {
      flex: 1;
      min-width: 0;
    }

    .route-input label {
      display: block;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .route-input input {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 5px 8px;
      font-size: 12px;
      outline: none;
      background: #F9FAFB;
    }

    .route-input input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.16);
      background: #FFFFFF;
    }

    .top-right {
      text-align: right;
      margin-left: 6px;
    }

    .top-right .title {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--primary);
      border-left: 2px solid var(--primary);
      padding-left: 6px;
      line-height: 1.2;
    }

    .top-right .subtitle {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .section-card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 10px 10px 8px;
      margin-bottom: 10px;
      border: 1px solid rgba(148,163,184,0.35);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .section-header h2 {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }

    .badge-today {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
    }

    .day-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }

    .day-selector {
      flex: 1;
    }

    .day-selector label {
      display: block;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .day-selector select {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px 9px;
      font-size: 12px;
      background: #F9FAFB;
      outline: none;
    }

    .day-selector select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.16);
      background: #FFFFFF;
    }

    .day-note {
      font-size: 10px;
      color: var(--text-muted);
      max-width: 45%;
      line-height: 1.2;
    }

    .search-row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 6px;
    }

    .search-field {
      flex: 1;
      position: relative;
    }

    .search-field label {
      display: block;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .search-field input {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px 26px 6px 8px;
      font-size: 12px;
      background: #F9FAFB;
      outline: none;
    }

    .search-field input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.16);
      background: #FFFFFF;
    }

    .search-icon {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 13px;
      color: var(--text-muted);
      pointer-events: none;
    }

    .add-client-btn {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      background: var(--accent);
      color: #FFFFFF;
      box-shadow: 0 4px 10px rgba(37,99,235,0.35);
      flex-shrink: 0;
    }

    .add-client-btn:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(37,99,235,0.4);
    }

    .hint-text {
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .result-list {
      max-height: 140px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid rgba(209, 213, 219, 0.8);
      background: #F9FAFB;
      padding: 2px;
    }

    .result-item {
      padding: 6px 8px;
      border-radius: 8px;
      margin: 2px;
      cursor: pointer;
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .result-item:hover {
      background: #E5EDF7;
    }

    .result-item.selected {
      background: #DBEAFE;
      border: 1px solid var(--accent);
    }

    .result-name {
      font-weight: 600;
      color: var(--text-main);
    }

    .result-meta {
      font-size: 10px;
      color: var(--text-muted);
    }

    .actions-row {
      display: flex;
      justify-content: flex-end;
      margin-top: 6px;
      gap: 6px;
    }

    .btn {
      border-radius: 999px;
      padding: 6px 16px;
      font-size: 12px;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }

    .btn-primary {
      background: var(--primary);
      color: #FFFFFF;
      box-shadow: 0 4px 10px rgba(15,59,95,0.35);
    }

    .btn-primary:disabled {
      background: #9CA3AF;
      box-shadow: none;
      cursor: default;
    }

    .btn-primary:active:not(:disabled) {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(15,59,95,0.4);
    }

    .btn-restruct {
      width: 100%;
      justify-content: center;
      margin-top: 4px;
      padding: 8px 16px;
      background: linear-gradient(to right, #0F3B5F, #2563EB);
      color: #FFFFFF;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      border-radius: 999px;
      box-shadow: 0 6px 14px rgba(37,99,235,0.35);
    }

    .btn-restruct:active {
      transform: translateY(1px);
      box-shadow: 0 3px 8px rgba(37,99,235,0.45);
    }

    .btn-restruct span.icon {
      font-size: 14px;
    }

    .btn-restruct span.label {
      font-weight: 600;
    }

    .section-res {
      background: var(--card);
      border-radius: 18px;
      padding: 10px;
      border: 1px solid rgba(148,163,184,0.5);
    }

    .res-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .res-header h2 {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }

    .res-count {
      font-size: 10px;
      color: var(--text-muted);
    }

    .day-block {
      margin-top: 8px;
      border-radius: 14px;
      border: 1px solid rgba(209,213,219,0.9);
      overflow: hidden;
      background: #F9FAFB;
    }

    .day-block-header {
      background: linear-gradient(to right, #0F3B5F, #2563EB);
      color: #FFFFFF;
      padding: 6px 8px;
      font-size: 11px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .day-block-header strong {
      font-weight: 600;
    }

    .day-block-header span {
      font-size: 10px;
      opacity: 0.9;
    }

    .day-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .day-table thead {
      background: #E5E7EB;
    }

    .day-table th,
    .day-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #E5E7EB;
      text-align: left;
    }

    .day-table th {
      font-weight: 600;
      color: #374151;
    }

    .day-table tr:nth-child(even) td {
      background: #F3F4F6;
    }

    .empty-state {
      font-size: 11px;
      color: var(--text-muted);
      background: #F9FAFB;
      border-radius: 12px;
      padding: 8px;
      border: 1px dashed #D1D5DB;
    }

    /* Modal nuevo cliente */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .modal {
      width: 100%;
      max-width: 420px;
      background: var(--card);
      border-radius: 22px;
      padding: 12px 12px 10px;
      box-shadow: 0 14px 36px rgba(15,23,42,0.55);
      border: 1px solid rgba(15,59,95,0.2);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--primary);
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      color: var(--text-muted);
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 60vh;
      overflow-y: auto;
      padding-right: 2px;
    }

    .field-group label {
      display: block;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .field-group input {
      width: 100%;
      border-radius: 10px;
      border: 1px solid var(--border);
      padding: 6px 8px;
      font-size: 12px;
      background: #F9FAFB;
      outline: none;
    }

    .field-group input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.18);
      background: #FFFFFF;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 8px;
    }

    .btn-secondary {
      background: #E5E7EB;
      color: #111827;
    }

    .toast {
      position: fixed;
      bottom: 14px;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 12px;
      border-radius: 999px;
      background: #059669;
      color: #FFFFFF;
      font-size: 11px;
      display: none;
      z-index: 30;
      box-shadow: 0 8px 20px rgba(5,150,105,0.5);
    }

    .toast.error {
      background: var(--danger);
      box-shadow: 0 8px 20px rgba(185,28,28,0.5);
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- Encabezado -->
    <header class="top-bar">
      <div class="top-left">
        <label class="file-label" for="dbInput" title="Cargar base de datos (.txt)">
          <span>üìÇ</span>
        </label>
        <input id="dbInput" type="file" accept=".txt" />
        <div class="route-input">
          <label for="routeInput">Ruta</label>
          <input id="routeInput" type="text" placeholder="Ej. 17029" inputmode="numeric" />
        </div>
      </div>
      <div class="top-right">
        <div class="title">REGISTRO DE CLIENTES</div>
        <div class="subtitle">Base TXT ¬∑ RUTA ¬∑ NEGOCIO ¬∑ DIRECCI√ìN</div>
      </div>
    </header>

    <!-- D√≠a y b√∫squeda -->
    <section class="section-card">
      <div class="section-header">
        <h2>D√≠a y b√∫squeda</h2>
        <div class="badge-today" id="todayBadge">Hoy: ‚Äî</div>
      </div>

      <div class="day-row">
        <div class="day-selector">
          <label for="daySelect">D√≠a de trabajo</label>
          <select id="daySelect">
            <option value="0">Lunes</option>
            <option value="1">Martes</option>
            <option value="2">Mi√©rcoles</option>
            <option value="3">Jueves</option>
            <option value="4">Viernes</option>
            <option value="5">S√°bado</option>
          </select>
        </div>
        <p class="day-note">
          Detecta el d√≠a actual de forma autom√°tica, pero puedes cambiarlo para asignar clientes a otros d√≠as.
        </p>
      </div>

      <div class="search-row">
        <div class="search-field">
          <label for="searchInput">Buscar cliente</label>
          <input id="searchInput" type="text" placeholder="Por ruta o nombre del negocio" />
          <span class="search-icon">üîç</span>
        </div>
        <button class="add-client-btn" id="btnNewClient" title="Crear cliente nuevo">
          +
        </button>
      </div>

      <p class="hint-text">
        Carga primero la base .txt. Puedes filtrar por <strong>ruta</strong> (campo superior) o por <strong>nombre del negocio</strong>.
      </p>

      <div class="result-list" id="resultList">
        <!-- Resultados de b√∫squeda -->
      </div>

      <div class="actions-row">
        <button class="btn btn-primary" id="btnSaveClient" disabled>
          <span>‚úî</span> Guardar en d√≠a
        </button>
      </div>
    </section>

    <!-- Bot√≥n REESTRUCTURA -->
    <button class="btn btn-restruct" id="btnRestruct">
      <span class="icon">‚öô</span>
      <span class="label">Reestructura</span>
    </button>

    <!-- Tabla reestructurada -->
    <section class="section-res" style="margin-top: 10px;">
      <div class="res-header">
        <h2>Ruta reestructurada por d√≠a</h2>
        <div class="res-count" id="summaryCount">0 clientes asignados</div>
      </div>

      <div id="restructuredContainer">
        <div class="empty-state">
          A√∫n no hay clientes asignados. Selecciona un cliente y usa el bot√≥n <strong>Guardar en d√≠a</strong>. Luego presiona
          <strong>REESTRUCTURA</strong> para ver la tabla ordenada por d√≠a.
        </div>
      </div>
    </section>
  </div>

  <!-- Modal nuevo cliente -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Nuevo cliente</div>
        <button class="modal-close" id="modalCloseBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="field-group">
          <label for="newRoute">Ruta</label>
          <input id="newRoute" type="text" placeholder="Ej. 17029" inputmode="numeric" />
        </div>
        <div class="field-group">
          <label for="newCode">C√≥digo</label>
          <input id="newCode" type="text" placeholder="C√≥digo interno" />
        </div>
        <div class="field-group">
          <label for="newName">Nombre del negocio</label>
          <input id="newName" type="text" placeholder="Ej. Tienda Marissa" />
        </div>
        <div class="field-group">
          <label for="newAddress">Direcci√≥n</label>
          <input id="newAddress" type="text" placeholder="Direcci√≥n del negocio" />
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="modalCancelBtn">Cancelar</button>
        <button class="btn btn-primary" id="modalSaveBtn">Guardar cliente</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ====== Estado de la app ======
    const DAY_NAMES = ["Lunes", "Martes", "Mi√©rcoles", "Jueves", "Viernes", "S√°bado"];

    /** Clientes cargados desde TXT o creados
     * { ruta, codigo, nombre, direccion }
     */
    let clients = [];

    /** Asignaciones a d√≠as
     * { dayIndex, ruta, codigo, nombre, direccion, timestamp }
     */
    let assignments = [];

    let selectedClientIndex = null; // √≠ndice en el arreglo clients

    // ====== Utilidades ======
    function showToast(message, isError = false) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.toggle("error", isError);
      toast.style.display = "inline-flex";
      setTimeout(() => {
        toast.style.display = "none";
      }, 2200);
    }

    function getTodayDayIndex() {
      const jsDay = new Date().getDay(); // 0=Domingo, 1=Lunes...
      if (jsDay === 0) return 0; // Domingo -> Lunes (0)
      if (jsDay >= 1 && jsDay <= 6) return jsDay - 1; // Lunes-S√°bado
      return 0;
    }

    function updateTodayBadge() {
      const idx = getTodayDayIndex();
      const badge = document.getElementById("todayBadge");
      badge.textContent = "Hoy: " + DAY_NAMES[idx];
    }

    function refreshSummaryCount() {
      const summary = document.getElementById("summaryCount");
      const total = assignments.length;
      summary.textContent = `${total} cliente${total === 1 ? "" : "s"} asignado${total === 1 ? "" : "s"}`;
    }

    // ====== Manejo de archivo TXT ======
    function parseTxtContent(text) {
      const lines = text.split(/\r?\n/);
      const parsed = [];

      for (let line of lines) {
        line = line.trim();
        if (!line) continue;

        // saltar encabezado
        if (/^ruta\s*/i.test(line) && line.toLowerCase().includes("codigo")) {
          continue;
        }

        // soportar separadores por tab, punto y coma o coma
        const parts = line.split(/\t|;|,/).map(p => p.trim()).filter(p => p.length > 0);
        if (parts.length < 4) continue;

        const ruta = parts[0];
        const codigo = parts[1];
        const nombre = parts[2];
        const direccion = parts.slice(3).join(" "); // resto

        parsed.push({ ruta, codigo, nombre, direccion });
      }

      return parsed;
    }

    function handleFileChange(event) {
      const file = event.target.files[0];
      if (!file) return;

      if (!file.name.toLowerCase().endsWith(".txt")) {
        showToast("Archivo inv√°lido. Usa un .txt", true);
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        const content = e.target.result;
        const parsed = parseTxtContent(content);
        if (!parsed.length) {
          showToast("No se encontraron clientes en el archivo", true);
          return;
        }
        clients = parsed;
        selectedClientIndex = null;
        renderSearchResults();
        showToast("Base de datos cargada (" + clients.length + " clientes)");
      };
      reader.onerror = () => {
        showToast("Error al leer el archivo", true);
      };
      reader.readAsText(file, "utf-8");
    }

    // ====== B√∫squeda de clientes ======
    function renderSearchResults() {
      const list = document.getElementById("resultList");
      list.innerHTML = "";

      if (!clients.length) {
        list.innerHTML = '<div class="empty-state" style="margin:2px;">Carga una base .txt o crea clientes nuevos.</div>';
        return;
      }

      const query = document.getElementById("searchInput").value.trim().toLowerCase();
      const routeFilter = document.getElementById("routeInput").value.trim();

      const filtered = clients.map((c, index) => ({ ...c, index }))
        .filter(c => {
          const matchesRoute = routeFilter ? String(c.ruta).includes(routeFilter) : true;
          const matchesQuery = query
            ? c.nombre.toLowerCase().includes(query) || String(c.ruta).toLowerCase().includes(query)
            : true;
          return matchesRoute && matchesQuery;
        });

      if (!filtered.length) {
        list.innerHTML = '<div class="empty-state" style="margin:2px;">Sin coincidencias. Ajusta tu b√∫squeda.</div>';
        selectedClientIndex = null;
        document.getElementById("btnSaveClient").disabled = true;
        return;
      }

      filtered.forEach(item => {
        const div = document.createElement("div");
        div.className = "result-item" + (item.index === selectedClientIndex ? " selected" : "");
        div.dataset.index = item.index;

        const nameEl = document.createElement("div");
        nameEl.className = "result-name";
        nameEl.textContent = item.nombre;

        const metaEl = document.createElement("div");
        metaEl.className = "result-meta";
        metaEl.textContent = `Ruta ${item.ruta} ¬∑ Cod. ${item.codigo}`;

        const addrEl = document.createElement("div");
        addrEl.className = "result-meta";
        addrEl.textContent = item.direccion;

        div.appendChild(nameEl);
        div.appendChild(metaEl);
        div.appendChild(addrEl);

        div.addEventListener("click", () => {
          selectedClientIndex = item.index;
          document.getElementById("btnSaveClient").disabled = false;
          renderSearchResults(); // para refrescar selecci√≥n
        });

        list.appendChild(div);
      });
    }

    // ====== Asignar cliente al d√≠a ======
    function saveSelectedClientToDay() {
      if (selectedClientIndex === null || selectedClientIndex < 0 || selectedClientIndex >= clients.length) {
        showToast("Selecciona un cliente primero", true);
        return;
      }
      const client = clients[selectedClientIndex];
      const dayIndex = parseInt(document.getElementById("daySelect").value, 10);

      assignments.push({
        dayIndex,
        ruta: client.ruta,
        codigo: client.codigo,
        nombre: client.nombre,
        direccion: client.direccion,
        timestamp: Date.now()
      });

      showToast(`Cliente asignado a ${DAY_NAMES[dayIndex]}`);
      refreshSummaryCount();
      renderRestructuredTable(); // para ver el cambio de una vez
    }

    // ====== REESTRUCTURA ======
    function renderRestructuredTable() {
      const container = document.getElementById("restructuredContainer");
      container.innerHTML = "";

      if (!assignments.length) {
        container.innerHTML = '<div class="empty-state">A√∫n no hay clientes asignados. Usa "Guardar en d√≠a" para agregar clientes por d√≠a.</div>';
        refreshSummaryCount();
        return;
      }

      // Ordenar por d√≠a y luego por timestamp (orden de agregado)
      const sorted = [...assignments].sort((a, b) => {
        if (a.dayIndex !== b.dayIndex) return a.dayIndex - b.dayIndex;
        return a.timestamp - b.timestamp;
      });

      // Agrupar por d√≠a
      const groups = {};
      sorted.forEach(item => {
        if (!groups[item.dayIndex]) groups[item.dayIndex] = [];
        groups[item.dayIndex].push(item);
      });

      Object.keys(groups).sort((a, b) => a - b).forEach(dayKey => {
        const dayIndex = parseInt(dayKey, 10);
        const dayClients = groups[dayIndex];

        const block = document.createElement("div");
        block.className = "day-block";

        const header = document.createElement("div");
        header.className = "day-block-header";
        const diaNum = dayIndex + 1; // D√≠a 1 = Lunes
        const title = document.createElement("div");
        title.innerHTML = `<strong>D√çA ${diaNum} ‚Äì ${DAY_NAMES[dayIndex].toUpperCase()}</strong>`;
        const count = document.createElement("span");
        count.textContent = `${dayClients.length} cliente${dayClients.length === 1 ? "" : "s"}`;

        header.appendChild(title);
        header.appendChild(count);

        const table = document.createElement("table");
        table.className = "day-table";
        const thead = document.createElement("thead");
        thead.innerHTML = `
          <tr>
            <th>#</th>
            <th>Negocio</th>
            <th>Ruta</th>
            <th>C√≥digo</th>
            <th>Direcci√≥n</th>
          </tr>
        `;
        const tbody = document.createElement("tbody");

        dayClients.forEach((c, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${idx + 1}</td>
            <td>${c.nombre}</td>
            <td>${c.ruta}</td>
            <td>${c.codigo}</td>
            <td>${c.direccion}</td>
          `;
          tbody.appendChild(tr);
        });

        table.appendChild(thead);
        table.appendChild(tbody);

        block.appendChild(header);
        block.appendChild(table);
        container.appendChild(block);
      });

      refreshSummaryCount();
    }

    // ====== Modal nuevo cliente ======
    function openModal() {
      const backdrop = document.getElementById("modalBackdrop");
      const routeInputTop = document.getElementById("routeInput");
      const newRoute = document.getElementById("newRoute");

      // Prellenar ruta con la ruta del encabezado si existe
      newRoute.value = routeInputTop.value.trim();

      backdrop.style.display = "flex";
      document.getElementById("newCode").value = "";
      document.getElementById("newName").value = "";
      document.getElementById("newAddress").value = "";
      document.getElementById("newName").focus();
    }

    function closeModal() {
      const backdrop = document.getElementById("modalBackdrop");
      backdrop.style.display = "none";
    }

    function saveNewClient() {
      const ruta = document.getElementById("newRoute").value.trim();
      const codigo = document.getElementById("newCode").value.trim();
      const nombre = document.getElementById("newName").value.trim();
      const direccion = document.getElementById("newAddress").value.trim();

      if (!ruta || !codigo || !nombre || !direccion) {
        showToast("Completa todos los campos del cliente", true);
        return;
      }

      const newClient = { ruta, codigo, nombre, direccion };
      clients.push(newClient);

      // Asignar autom√°ticamente al d√≠a seleccionado
      const dayIndex = parseInt(document.getElementById("daySelect").value, 10);
      assignments.push({
        dayIndex,
        ...newClient,
        timestamp: Date.now()
      });

      closeModal();
      showToast("Cliente creado y asignado al d√≠a");

      // Actualizar lista de b√∫squeda y tabla reestructurada
      selectedClientIndex = clients.length - 1;
      document.getElementById("btnSaveClient").disabled = false;
      renderSearchResults();
      renderRestructuredTable();
    }

    // ====== Inicializaci√≥n ======
    document.addEventListener("DOMContentLoaded", () => {
      // D√≠a actual
      const todayIndex = getTodayDayIndex();
      const daySelect = document.getElementById("daySelect");
      daySelect.value = String(todayIndex);
      updateTodayBadge();

      // Eventos
      document.getElementById("dbInput").addEventListener("change", handleFileChange);
      document.getElementById("searchInput").addEventListener("input", renderSearchResults);
      document.getElementById("routeInput").addEventListener("input", renderSearchResults);
      document.getElementById("btnSaveClient").addEventListener("click", saveSelectedClientToDay);
      document.getElementById("btnRestruct").addEventListener("click", () => {
        renderRestructuredTable();
        showToast("Tabla reestructurada actualizada");
      });

      document.getElementById("btnNewClient").addEventListener("click", openModal);
      document.getElementById("modalCloseBtn").addEventListener("click", closeModal);
      document.getElementById("modalCancelBtn").addEventListener("click", closeModal);
      document.getElementById("modalSaveBtn").addEventListener("click", saveNewClient);

      document.getElementById("modalBackdrop").addEventListener("click", (e) => {
        if (e.target.id === "modalBackdrop") {
          closeModal();
        }
      });

      // Render inicial
      renderSearchResults();
      renderRestructuredTable();
    });
  </script>
</body>
</html>
